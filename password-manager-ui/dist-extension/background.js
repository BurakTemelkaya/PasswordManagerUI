import{c as f}from"./chunks/config-BY7x5TM5.js";function T(e){const r=new Uint8Array(e.length/2);for(let t=0;t<e.length;t+=2)r[t/2]=parseInt(e.substring(t,t+2),16);return r.buffer}function m(e){const r=atob(e),t=new Uint8Array(r.length);for(let o=0;o<r.length;o++)t[o]=r.charCodeAt(o);return t.buffer}function b(e){return new TextDecoder().decode(e)}async function u(e,r,t){try{if(!e)return"";const o=T(r),s=m(t),n=m(e),a=await crypto.subtle.importKey("raw",o,{name:"AES-GCM"},!1,["decrypt"]),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:s},a,n);return b(l)}catch(o){return console.error("Decrypt error:",o),""}}async function P(e,r){try{const t=await u(e.encryptedName,r,e.iv),o=await u(e.encryptedUserName,r,e.iv),s=await u(e.encryptedPassword,r,e.iv),n=await u(e.encryptedWebSiteUrl,r,e.iv);return{id:e.id,name:t,username:o,password:s,websiteUrl:n}}catch(t){return console.error("Password decryption failed:",t),null}}async function y(e,r){try{const t=await fetch(`${r}/Auth/RefreshToken`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(!t.ok)return console.error("ðŸ”´ Refresh token baÅŸarÄ±sÄ±z:",t.status),null;const o=await t.json();return o.accessToken?.token&&(await chrome.storage.session.set({authToken:o.accessToken.token}),await chrome.storage.local.set({tokenExpiration:o.accessToken.expirationDate}),console.log("âœ… Background: Access token yenilendi")),o.refreshToken?.token&&(await chrome.storage.local.set({refreshToken:o.refreshToken.token,refreshTokenExpiration:o.refreshToken.expirationDate}),console.log("âœ… Background: Refresh token yenilendi")),{accessToken:o.accessToken?.token,refreshToken:o.refreshToken?.token}}catch(t){return console.error("ðŸ”´ Refresh token hatasÄ±:",t),null}}async function A(e,r,t){let o=await fetch(e,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(o.status===401){const n=(await chrome.storage.local.get(["refreshToken"])).refreshToken;if(n){const a=await y(n,t);a?.accessToken&&(o=await fetch(e,{headers:{Authorization:`Bearer ${a.accessToken}`,"Content-Type":"application/json"}}))}}return o}async function g(e,r){try{const t=await A(`${r}/Password/GetAll`,e,r);if(!t.ok)return console.error("API response not ok:",t.status),t.status===401&&(console.log("ðŸ”´ Token yenileme baÅŸarÄ±sÄ±z, oturum sonlandÄ±rÄ±lÄ±yor..."),await chrome.storage.session.remove(["authToken","encryptionKey"]),await chrome.storage.local.remove(["refreshToken","refreshTokenExpiration","passwords"])),null;const o=await t.json();return Array.isArray(o)?o:o.$values||[]}catch(t){return console.error("Fetch passwords error:",t),null}}function w(e){let r=e.replace(/^www\./,"");const t=r.split(".");return t.length>=2?t.slice(-2).join("."):r}function S(e,r){try{if(!e)return!1;const o=new URL(e.startsWith("http")?e:`https://${e}`).hostname,s=w(o),n=w(r);return s===n}catch{const t=e.toLowerCase().replace(/^www\./,""),o=r.toLowerCase().replace(/^www\./,"");return t.includes(o)||o.includes(t)}}const p=new Set;chrome.runtime.onInstalled.addListener(()=>{try{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"pm-main",title:"ðŸ” Parola YÃ¶neticisi",contexts:["all"]}),chrome.contextMenus.create({id:"pm-open",parentId:"pm-main",title:"Popup'Ä± AÃ§",contexts:["all"]}),chrome.contextMenus.create({id:"pm-fill",parentId:"pm-main",title:"Otomatik Doldur",contexts:["editable"]})}),chrome.storage.local.get(["encryptedPasswords","passwords"],e=>{console.log("ðŸš€ Extension Installed/Updated"),console.log("ðŸ”’ Encrypted Status:",e.encryptedPasswords?"âœ… Found":"âŒ Not Found"),console.log("âš ï¸ Legacy Plaintext Status:",e.passwords?"âŒ Found (Should be removed)":"âœ… Clean"),k()})}catch(e){console.error("Context menu error:",e)}});chrome.runtime.onStartup.addListener(()=>{k()});chrome.runtime.onMessage.addListener((e,r,t)=>((async()=>{try{switch(e.type){case"GET_PASSWORDS_FOR_SITE":await L(e.hostname,t);break;case"AUTOFILL_PASSWORD":await U(e),t({success:!0});break;case"LOGIN_FORM_DETECTED":v(r.tab?.id,e),t({success:!0});break;case"GET_CURRENT_TAB":await x(t);break;case"OPEN_POPUP":try{await chrome.action.openPopup()}catch{chrome.tabs.create({url:chrome.runtime.getURL("public/popup.html")})}t({success:!0});break;default:t({success:!1,message:"Unknown message type"})}}catch(o){console.error("Message handler error:",o),t({success:!1,error:String(o)})}})(),!0));async function L(e,r){try{const t=await chrome.storage.session.get(["authToken","encryptionKey"]),o=await chrome.storage.local.get(["apiUrl","encryptedPasswords","refreshToken"]);let s=t.authToken,n=t.encryptionKey;if(!s&&o.refreshToken){const i=o.apiUrl||f.api.baseURL,c=await y(o.refreshToken,i);c?.accessToken&&(s=c.accessToken)}if(!s||!n){r({success:!1,isAuthenticated:!1,passwords:[],message:"GiriÅŸ yapÄ±lmamÄ±ÅŸ"});return}let a=o.encryptedPasswords;if(!a||a.length===0){console.log("ðŸŒ API'den parolalar Ã§ekiliyor...");const i=o.apiUrl||f.api.baseURL,c=await g(s,i);c?(a=c,a.length>0&&(await chrome.storage.local.set({encryptedPasswords:a}),await chrome.storage.local.remove(["passwords"]))):a=[]}else console.log("ðŸ“¦ Åžifreli Ã¶nbellekten yÃ¼klendi");const l=[];if(a&&a.length>0)for(const i of a){const c=await P(i,n);c&&l.push(c)}const d=l.filter(i=>S(i.websiteUrl,e));let h;d.length>0?h=d:h=l.slice(0,10),r({success:!0,isAuthenticated:!0,passwords:h,matching:d.length})}catch(t){console.error("Get passwords error:",t),r({success:!1,isAuthenticated:!0,passwords:[],error:String(t)})}}async function k(){try{const e=await chrome.storage.local.get(["authToken","encryptedPasswords","apiUrl"]);if(e.authToken&&(!e.encryptedPasswords||!Array.isArray(e.encryptedPasswords))){console.log("ðŸ”„ Proactive: Auth token found but check missing. background.js Fetching...");const r=e.apiUrl||f.api.baseURL,t=await g(e.authToken,r);t?(await chrome.storage.local.set({encryptedPasswords:t}),console.log("âœ… Proactive: Cache populated with "+t.length+" items.")):console.log("âŒ Proactive: Fetch failed.")}}catch(e){console.error("Proactive sync error:",e)}}async function U(e){try{const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(r?.id)try{await chrome.tabs.sendMessage(r.id,{type:"AUTOFILL",username:e.username,password:e.password})}catch{await chrome.scripting.executeScript({target:{tabId:r.id},files:["content.js"]}),setTimeout(async()=>{await chrome.tabs.sendMessage(r.id,{type:"AUTOFILL",username:e.username,password:e.password})},100)}}catch(r){console.error("Autofill error:",r)}}function v(e,r){e&&(p.add(e),chrome.action.setBadgeText({text:"â—",tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#0d9488",tabId:e}))}async function x(e){try{const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});e({success:!0,tab:r?{id:r.id,url:r.url,title:r.title}:null})}catch(r){e({success:!1,error:String(r)})}}chrome.contextMenus.onClicked.addListener(async(e,r)=>{if(e.menuItemId==="pm-open")try{await chrome.action.openPopup()}catch{chrome.tabs.create({url:chrome.runtime.getURL("public/popup.html")})}e.menuItemId==="pm-fill"&&r?.id&&chrome.action.openPopup()});chrome.tabs.onRemoved.addListener(e=>{p.delete(e)});chrome.tabs.onUpdated.addListener((e,r)=>{r.url&&(p.delete(e),chrome.action.setBadgeText({text:"",tabId:e}))});
