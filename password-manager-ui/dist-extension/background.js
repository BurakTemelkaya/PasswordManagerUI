import{c as T}from"./chunks/config-D9A41Bfy.js";function b(e){const t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.substring(r,r+2),16);return t.buffer}function w(e){const t=atob(e),r=new Uint8Array(t.length);for(let o=0;o<t.length;o++)r[o]=t.charCodeAt(o);return r.buffer}function A(e){return new TextDecoder().decode(e)}async function u(e,t,r){try{if(!e)return"";const o=b(t),a=w(r),s=w(e),n=await crypto.subtle.importKey("raw",o,{name:"AES-GCM"},!1,["decrypt"]),h=await crypto.subtle.decrypt({name:"AES-GCM",iv:a},n,s);return A(h)}catch(o){return console.error("Decrypt error:",o),""}}async function P(e,t){try{const r=await u(e.encryptedName,t,e.iv),o=await u(e.encryptedUserName,t,e.iv),a=await u(e.encryptedPassword,t,e.iv),s=await u(e.encryptedWebSiteUrl,t,e.iv);return{id:e.id,name:r,username:o,password:a,websiteUrl:s}}catch(r){return console.error("Password decryption failed:",r),null}}async function x(e,t){try{const r=await fetch(`${t}/Auth/RefreshToken`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(!r.ok)return console.error("ðŸ”´ Refresh token baÅŸarÄ±sÄ±z:",r.status),null;const o=await r.json();return o.accessToken?.token&&(await chrome.storage.session.set({authToken:o.accessToken.token}),await chrome.storage.local.set({tokenExpiration:o.accessToken.expirationDate}),console.log("âœ… Background: Access token yenilendi")),o.refreshToken?.token&&(await chrome.storage.local.set({refreshToken:o.refreshToken.token,refreshTokenExpiration:o.refreshToken.expirationDate}),console.log("âœ… Background: Refresh token yenilendi")),{accessToken:o.accessToken?.token,refreshToken:o.refreshToken?.token}}catch(r){return console.error("ðŸ”´ Refresh token hatasÄ±:",r),null}}async function S(e,t,r){let o=await fetch(e,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(o.status===401){const s=(await chrome.storage.local.get(["refreshToken"])).refreshToken;if(s){const n=await x(s,r);n?.accessToken&&(o=await fetch(e,{headers:{Authorization:`Bearer ${n.accessToken}`,"Content-Type":"application/json"}}))}}return o}async function L(e,t){try{const r=await S(`${t}/Password/GetAll`,e,t);if(!r.ok)throw console.error("API response not ok:",r.status),r.status===401&&(console.log("ðŸ”´ Token yenileme baÅŸarÄ±sÄ±z, oturum sonlandÄ±rÄ±lÄ±yor..."),await chrome.storage.session.remove(["authToken","encryptionKey"]),await chrome.storage.local.remove(["refreshToken","refreshTokenExpiration","passwords"])),new Error(`API error: ${r.status}`);const o=await r.json();return Array.isArray(o)?o:o.$values||[]}catch(r){return console.error("Fetch passwords error:",r),[]}}function y(e){let t=e.replace(/^www\./,"");const r=t.split(".");return r.length>=2?r.slice(-2).join("."):t}function g(e,t){try{if(!e)return!1;const o=new URL(e.startsWith("http")?e:`https://${e}`).hostname,a=y(o),s=y(t);return a===s}catch{const r=e.toLowerCase().replace(/^www\./,""),o=t.toLowerCase().replace(/^www\./,"");return r.includes(o)||o.includes(r)}}const m=new Set;chrome.runtime.onInstalled.addListener(()=>{try{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"pm-main",title:"ðŸ” Parola YÃ¶neticisi",contexts:["all"]}),chrome.contextMenus.create({id:"pm-open",parentId:"pm-main",title:"Popup'Ä± AÃ§",contexts:["all"]}),chrome.contextMenus.create({id:"pm-fill",parentId:"pm-main",title:"Otomatik Doldur",contexts:["editable"]})})}catch(e){console.error("Context menu error:",e)}});chrome.runtime.onMessage.addListener((e,t,r)=>((async()=>{try{switch(e.type){case"GET_PASSWORDS_FOR_SITE":await C(e.hostname,r);break;case"AUTOFILL_PASSWORD":await D(e),r({success:!0});break;case"LOGIN_FORM_DETECTED":v(t.tab?.id,e),r({success:!0});break;case"GET_CURRENT_TAB":await U(r);break;case"OPEN_POPUP":try{await chrome.action.openPopup()}catch{chrome.tabs.create({url:chrome.runtime.getURL("public/popup.html")})}r({success:!0});break;default:r({success:!1,message:"Unknown message type"})}}catch(o){console.error("Message handler error:",o),r({success:!1,error:String(o)})}})(),!0));async function C(e,t){try{const r=await chrome.storage.session.get(["authToken","encryptionKey"]),o=await chrome.storage.local.get(["apiUrl","passwords"]),a=r.authToken,s=r.encryptionKey;if(!a||!s){t({success:!1,isAuthenticated:!1,passwords:[],message:"GiriÅŸ yapÄ±lmamÄ±ÅŸ"});return}const n=o.passwords;if(n&&n.length>0){const c=n.filter(k=>g(k.websiteUrl,e));let i;c.length>0?i=c:i=n.slice(0,10),t({success:!0,isAuthenticated:!0,passwords:i,matching:c.length});return}console.log("ðŸŒ API'den parolalar Ã§ekiliyor...");const h=o.apiUrl||T.api.baseURL,p=await L(a,h);if(p.length===0&&!(await chrome.storage.session.get(["authToken"])).authToken){t({success:!1,isAuthenticated:!1,passwords:[],message:"Oturum sÃ¼resi doldu"});return}const l=[];for(const c of p){const i=await P(c,s);i&&l.push(i)}l.length>0&&await chrome.storage.local.set({passwords:l});const d=l.filter(c=>g(c.websiteUrl,e));let f;d.length>0?f=d:f=l.slice(0,10),t({success:!0,isAuthenticated:!0,passwords:f,matching:d.length})}catch(r){console.error("Get passwords error:",r),t({success:!1,isAuthenticated:!0,passwords:[],error:String(r)})}}async function D(e){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t?.id)try{await chrome.tabs.sendMessage(t.id,{type:"AUTOFILL",username:e.username,password:e.password})}catch{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),setTimeout(async()=>{await chrome.tabs.sendMessage(t.id,{type:"AUTOFILL",username:e.username,password:e.password})},100)}}catch(t){console.error("Autofill error:",t)}}function v(e,t){e&&(m.add(e),chrome.action.setBadgeText({text:"â—",tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#0d9488",tabId:e}))}async function U(e){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});e({success:!0,tab:t?{id:t.id,url:t.url,title:t.title}:null})}catch(t){e({success:!1,error:String(t)})}}chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(e.menuItemId==="pm-open")try{await chrome.action.openPopup()}catch{chrome.tabs.create({url:chrome.runtime.getURL("public/popup.html")})}e.menuItemId==="pm-fill"&&t?.id&&chrome.action.openPopup()});chrome.tabs.onRemoved.addListener(e=>{m.delete(e)});chrome.tabs.onUpdated.addListener((e,t)=>{t.url&&(m.delete(e),chrome.action.setBadgeText({text:"",tabId:e}))});
