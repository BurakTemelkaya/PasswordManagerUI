import{c as w}from"./chunks/config-DmK0IJcx.js";function y(e){const t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.substr(r,2),16);return t.buffer}function f(e){const t=atob(e),r=new Uint8Array(t.length);for(let o=0;o<t.length;o++)r[o]=t.charCodeAt(o);return r.buffer}function g(e){return new TextDecoder().decode(e)}async function u(e,t,r){try{if(!e)return"";const o=y(t),a=f(r),s=f(e),c=await crypto.subtle.importKey("raw",o,{name:"AES-GCM"},!1,["decrypt"]),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:a},c,s);return g(n)}catch(o){return console.error("Decrypt error:",o),""}}async function b(e,t){try{const r=await u(e.encryptedName,t,e.iv),o=await u(e.encryptedUserName,t,e.iv),a=await u(e.encryptedPassword,t,e.iv),s=await u(e.encryptedWebSiteUrl,t,e.iv);return console.log("Decrypted password:",{id:e.id,name:r,username:o,websiteUrl:s?.substring(0,30)}),{id:e.id,name:r,username:o,password:a,websiteUrl:s}}catch(r){return console.error("Password decryption failed:",r),null}}async function A(e,t){try{const r=await fetch(`${t}/Password/GetAll`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)throw console.error("API response not ok:",r.status),new Error(`API error: ${r.status}`);const o=await r.json();return console.log("API response:",o),Array.isArray(o)?o:o.$values||[]}catch(r){return console.error("Fetch passwords error:",r),[]}}function T(e,t){try{if(!e)return!1;const r=new URL(e.startsWith("http")?e:`https://${e}`);return r.hostname.includes(t)||t.includes(r.hostname)}catch{return e.toLowerCase().includes(t.toLowerCase())}}const m=new Set;chrome.runtime.onInstalled.addListener(()=>{console.log("ğŸ” Parola YÃ¶neticisi eklentisi yÃ¼klendi");try{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"pm-main",title:"ğŸ” Parola YÃ¶neticisi",contexts:["all"]}),chrome.contextMenus.create({id:"pm-open",parentId:"pm-main",title:"Popup'Ä± AÃ§",contexts:["all"]}),chrome.contextMenus.create({id:"pm-fill",parentId:"pm-main",title:"Otomatik Doldur",contexts:["editable"]})})}catch(e){console.error("Context menu error:",e)}});chrome.runtime.onMessage.addListener((e,t,r)=>(console.log("ğŸ“¨ Background message:",e.type),(async()=>{try{switch(e.type){case"GET_PASSWORDS_FOR_SITE":await P(e.hostname,r);break;case"AUTOFILL_PASSWORD":await k(e),r({success:!0});break;case"LOGIN_FORM_DETECTED":L(t.tab?.id,e),r({success:!0});break;case"GET_CURRENT_TAB":await S(r);break;case"OPEN_POPUP":try{await chrome.action.openPopup()}catch{chrome.tabs.create({url:chrome.runtime.getURL("public/popup.html")})}r({success:!0});break;default:r({success:!1,message:"Unknown message type"})}}catch(o){console.error("Message handler error:",o),r({success:!1,error:String(o)})}})(),!0));async function P(e,t){try{const r=await chrome.storage.session.get(["authToken","encryptionKey"]),o=await chrome.storage.local.get(["apiUrl"]),a=r.authToken,s=r.encryptionKey,c=o.apiUrl||w.api.baseURL;if(console.log("Auth check:",{hasToken:!!a,hasKey:!!s}),!a||!s){t({success:!1,isAuthenticated:!1,passwords:[],message:"GiriÅŸ yapÄ±lmamÄ±ÅŸ"});return}const n=await A(a,c);if(n.length===0)try{if((await fetch(`${c}/passwords`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}})).status===401){await chrome.storage.local.remove(["authToken","encryptionKey","userName","userId"]),t({success:!1,isAuthenticated:!1,passwords:[],message:"Oturum sÃ¼resi doldu"});return}}catch{}const l=[];for(const i of n){const p=await b(i,s);p&&l.push(p)}const d=l.filter(i=>T(i.websiteUrl,e));let h;d.length>0?h=d:h=l.slice(0,10),t({success:!0,isAuthenticated:!0,passwords:h,matching:d.length})}catch(r){console.error("Get passwords error:",r),t({success:!1,isAuthenticated:!0,passwords:[],error:String(r)})}}async function k(e){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t?.id)try{await chrome.tabs.sendMessage(t.id,{type:"AUTOFILL",username:e.username,password:e.password})}catch{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]}),setTimeout(async()=>{await chrome.tabs.sendMessage(t.id,{type:"AUTOFILL",username:e.username,password:e.password})},100)}}catch(t){console.error("Autofill error:",t)}}function L(e,t){e&&(m.add(e),chrome.action.setBadgeText({text:"â—",tabId:e}),chrome.action.setBadgeBackgroundColor({color:"#0d9488",tabId:e}))}async function S(e){try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});e({success:!0,tab:t?{id:t.id,url:t.url,title:t.title}:null})}catch(t){e({success:!1,error:String(t)})}}chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(e.menuItemId==="pm-open")try{await chrome.action.openPopup()}catch{chrome.tabs.create({url:chrome.runtime.getURL("public/popup.html")})}e.menuItemId==="pm-fill"&&t?.id&&chrome.action.openPopup()});chrome.tabs.onRemoved.addListener(e=>{m.delete(e)});chrome.tabs.onUpdated.addListener((e,t)=>{t.url&&(m.delete(e),chrome.action.setBadgeText({text:"",tabId:e}))});console.log("ğŸ” Background service worker baÅŸlatÄ±ldÄ±");
